name: Migrate Dev Database

# This workflow applies migrations to the dev database.
# For security, it only runs:
# 1. Manually via workflow_dispatch (for maintainers)
# 2. On approved PRs from collaborators (not forks)

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  # Manual trigger - maintainers can run this after reviewing schema changes
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to apply migrations from"
        required: true
        type: number

  # Auto-trigger on PR approval (only for non-fork PRs)
  pull_request_review:
    types: [submitted]

jobs:
  # Job 1: Manual migration via workflow dispatch
  manual-migrate:
    name: Manual database migration
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: development # Requires environment approval if configured

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ inputs.pr_number }}/head

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Apply migrations to dev database
        run: bun db:migrate
        env:
          DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}

      - name: Trigger Vercel redeploy
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr_number }}
            });
            const branch = pr.head.ref;
            
            // Get latest deployment for this branch
            const deploymentsRes = await fetch(
              `https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&target=preview&limit=50`,
              {
                headers: {
                  Authorization: `Bearer ${{ secrets.VERCEL_TOKEN }}`,
                },
              }
            );
            const { deployments } = await deploymentsRes.json();
            const deployment = deployments.find(d => d.meta?.githubCommitRef === branch);
            
            if (!deployment) {
              core.warning(`No deployment found for branch: ${branch}`);
              return;
            }
            
            // Redeploy
            const redeployRes = await fetch(
              `https://api.vercel.com/v13/deployments?forceNew=1&teamId=${{ secrets.VERCEL_ORG_ID }}`,
              {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${{ secrets.VERCEL_TOKEN }}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  name: deployment.name,
                  deploymentId: deployment.uid,
                }),
              }
            );
            
            if (!redeployRes.ok) {
              const error = await redeployRes.text();
              core.setFailed(`Failed to redeploy: ${error}`);
              return;
            }
            
            const newDeployment = await redeployRes.json();
            core.info(`Redeployed: https://${newDeployment.url}`);

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Database migrations applied to dev environment by @${{ github.actor }}. Vercel redeploy triggered.'
            })

  # Job 2: Auto-migrate on PR approval (only for trusted contributors)
  auto-migrate-on-approval:
    name: Auto migration on approval
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.review.state == 'approved' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    environment: development # Requires environment approval if configured

    steps:
      - name: Check if migrations changed
        id: check-migrations
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            const migrationsChanged = files.some(f =>
              f.filename.startsWith('drizzle/') || f.filename === 'db/schema.ts'
            );
            core.setOutput('changed', migrationsChanged);
            return migrationsChanged;

      - name: Checkout code
        if: steps.check-migrations.outputs.changed == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Bun
        if: steps.check-migrations.outputs.changed == 'true'
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        if: steps.check-migrations.outputs.changed == 'true'
        run: bun install

      - name: Apply migrations to dev database
        if: steps.check-migrations.outputs.changed == 'true'
        run: bun db:migrate
        env:
          DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}

      - name: Trigger Vercel redeploy
        if: steps.check-migrations.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ github.event.pull_request.head.ref }}';
            
            // Get latest deployment for this branch
            const deploymentsRes = await fetch(
              `https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&target=preview&limit=50`,
              {
                headers: {
                  Authorization: `Bearer ${{ secrets.VERCEL_TOKEN }}`,
                },
              }
            );
            const { deployments } = await deploymentsRes.json();
            const deployment = deployments.find(d => d.meta?.githubCommitRef === branch);
            
            if (!deployment) {
              core.warning(`No deployment found for branch: ${branch}`);
              return;
            }
            
            // Redeploy
            const redeployRes = await fetch(
              `https://api.vercel.com/v13/deployments?forceNew=1&teamId=${{ secrets.VERCEL_ORG_ID }}`,
              {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${{ secrets.VERCEL_TOKEN }}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  name: deployment.name,
                  deploymentId: deployment.uid,
                }),
              }
            );
            
            if (!redeployRes.ok) {
              const error = await redeployRes.text();
              core.setFailed(`Failed to redeploy: ${error}`);
              return;
            }
            
            const newDeployment = await redeployRes.json();
            core.info(`Redeployed: https://${newDeployment.url}`);

      - name: Comment on PR
        if: steps.check-migrations.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Database migrations applied to dev environment (triggered by approval from @${{ github.event.review.user.login }}). Vercel redeploy triggered.'
            })
